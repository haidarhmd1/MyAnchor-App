// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  // output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum TaxonomyType {
  AVOIDANCE_REASON
  SYMPTOM
  STOP_REASON
  AFTER_ATTACK_ACTION
  KEPT_GOING_REASON
  SKIPPED_CHALLENGE_REASON
}

enum WhenDidItHappen {
  MORNING
  NOON
  AFTERNOON
  EVENING
  NIGHT
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum Engagement {
  STAY
  PARTICIPATE
  STRETCH
}

enum SocialContext {
  ALONE
  WITH_OTHERS
}

enum ChallengeStatus {
  NOT_STARTED
  STARTED
  FINISHED
}

model EmailOTP {
  id         String    @id @default(cuid())
  email      String    @db.VarChar(255)
  tokenHash  String    @db.VarChar(255)
  expiresAt  DateTime
  consumedAt DateTime?
  attempts   Int       @default(0)
  createdAt  DateTime  @default(now())
  ip         String?
  userAgent  String?

  @@index([email])
  @@index([expiresAt])
}

model EmailLog {
  id         String   @id @default(cuid())
  toEmail    String   @db.VarChar(255)
  template   String?
  providerId String?
  success    Boolean
  error      String?
  createdAt  DateTime @default(now())

  @@index([toEmail, createdAt])
}

model SignInAudit {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  email     String   @db.VarChar(255)
  ip        String?
  userAgent String?
  method    String   @default("email-otp")
  outcome   String   @default("success") // or "failure"
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
}

model Consent {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  policy      String
  version     String
  grantedAt   DateTime  @default(now())
  withdrawnAt DateTime?

  @@index([userId, policy])
}

model RateLimitBucket {
  key       String   @id // e.g. otp:email:user@example.com or otp:ip:1.2.3.4
  tokens    Int      @default(0)
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  dob           DateTime?
  gender        Gender?
  image         String?
  deletedAt     DateTime?

  signInAudits SignInAudit[]
  consents     Consent[]

  challenges Challenge[]
  momentLog  MomentLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([deletedAt])
}

model TaxonomyItem {
  id          String       @id @default(cuid())
  type        TaxonomyType
  slug        String       @unique
  label       String
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sortOrder Int @default(0)

  @@index([type, sortOrder])
}

model ChallengeOption {
  id          String     @id @default(cuid())
  slug        String     @unique
  label       String
  description String?
  engagement  Engagement

  sortOrder  Int         @default(0)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  challenges Challenge[]

  @@index([sortOrder])
}

model Challenge {
  id            String        @id @default(cuid())
  socialContext SocialContext

  status  ChallengeStatus   @default(NOT_STARTED)
  outcome ChallengeOutcome?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  challengeOptionId String
  challengeOption   ChallengeOption @relation(fields: [challengeOptionId], references: [id], onDelete: Restrict)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([userId, createdAt])
  @@index([deletedAt])
}

model ChallengeOutcome {
  id          String    @id @default(cuid())
  challengeId String    @unique
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  didComplete    Boolean
  safetyBehavior String?

  // Optional clinician-mode fields (try not to use in core UX)
  // afterAttackActions String[]
  // keptGoingReasons   String[]
  // skippedReasons     String[]
  // hadPanicLikeSpike  Boolean?
  // notedSymptoms      String[] // slugs of TaxonomyItem(type=SYMPTOM)
  // stoppedEarly       Boolean?
  // anxietyLevel       Int?
  // copingStrategies   String[]
  // End Optional

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

model LocationOption {
  id          String  @id @default(cuid())
  slug        String  @unique
  label       String
  description String?

  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sortOrder])
}

model MomentLog {
  id String @id @default(cuid())

  location    String
  urge        String
  actionTaken String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([deletedAt])
}
